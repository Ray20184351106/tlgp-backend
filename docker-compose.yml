#version: '3.8' # 使用较新的版本
services:
    mysql:
        image: mysql:8.0 # 选择合适的 MySQL 版本
        container_name: mysql # 可选：指定容器名
        restart: always
        environment:
            MYSQL_ROOT_PASSWORD: mysql # 设置 root 密码，必须修改！
            MYSQL_DATABASE: tlgp # 启动时创建数据库，根据需要修改
            MYSQL_USER: user # 启动时创建用户，根据需要修改
            MYSQL_PASSWORD: mysql # 为新用户设置密码，必须修改！
        ports: # 生产环境建议注释掉，内部服务通过服务名访问
            - "3306:3306"
        volumes:
            # - /opt/my-microservice/mysql/conf/my.cnf:/etc/mysql/conf.d/my.cnf # 可选：自定义配置
            - /opt/my-microservice/mysql/data:/var/lib/mysql # 挂载数据目录，持久化数据，路径已修正
        command: --default-authentication-plugin=mysql_native_password # 解决一些连接问题
        # 注意：如果使用了 MYSQL_USER 和 MYSQL_PASSWORD，你的微服务配置文件中
        # 数据库用户名应为 'app_user'，密码应为 'YourActualAppUserPassword'
        # 数据库名应为 'myapp_db'
    nacos:
        image: nacos-registry.cn-hangzhou.cr.aliyuncs.com/nacos/nacos-server:v2.2.3 # 选择合适的 Nacos 版本
        container_name: nacos
        restart: always
        environment:
            - MODE=standalone # 嵌入式模式
            - SPRING_DATASOURCE_PLATFORM=mysql # 指定数据源为 MySQL (可选，嵌入式默认 Derby)
            - MYSQL_SERVICE_HOST=mysql # 如果使用 MySQL 存储配置，指向 MySQL 服务名
            - MYSQL_SERVICE_PORT=3306
            - MYSQL_SERVICE_DB_NAME=tlgp # 数据库名
            - MYSQL_SERVICE_USER=root # 用户名
            - MYSQL_SERVICE_PASSWORD=mysql # 密码，与 MySQL 设置一致
            - NACOS_SERVER_IP=8.162.4.221 # 重要：设置为你的阿里云服务器公网 IP，确保客户端能正确连接
        ports:
            - "8848:8848" # Nacos 控制台和 API 端口
            - "9848:9848" # 客户端 gRPC 服务端口 (可选)
            - "9849:9849" # 客户端 gRPC 服务端口 (可选)
        depends_on:
            - mysql # 确保 Nacos 在 MySQL 启动后再启动
        volumes:
            - /opt/my-microservice/nacos/logs:/home/nacos/logs # 挂载日志目录
            # - /opt/my-microservice/nacos/init.d/custom.properties:/home/nacos/init.d/custom.properties # 挂载自定义配置文件 (可选)
    tlgp-gateway: # 服务名
        # 如果镜像已构建好并推送到仓库
        # image: your-registry/user-service:v1.0
        # 如果使用本地构建
        build:
            context: ./tlgp-gateway # Dockerfile 所在的相对路径
            dockerfile: Dockerfile
        container_name: tlgp-gateway
        restart: always
        ports:
            - "9000:9000" # 将容器端口映射到主机端口
        environment:
            - SPRING_PROFILES_ACTIVE=dev # 指定 Spring 配置文件环境
        # - NACOS_SERVER_ADDR=nacos:8848 # 指向 Nacos 服务，使用服务名
        # - MYSQL_HOST=mysql # 指向 MySQL 服务，使用服务名
        # - MYSQL_PORT=3306
        # - MYSQL_DATABASE=tlgp
        # - MYSQL_USER=user
        # - MYSQL_PASSWORD=mysql
        depends_on:
            - nacos
            - mysql
        # volumes:
        #   - /path/to/local/config:/app/config # 挂载配置文件 (可选)
    tlgp-order-service: # 服务名
        # 如果镜像已构建好并推送到仓库
        # image: your-registry/user-service:v1.0
        # 如果使用本地构建
        build:
            context: ./tlgp-order-service # Dockerfile 所在的相对路径
            dockerfile: Dockerfile
        container_name: tlgp-order-service
        restart: always
        ports:
            - "8081:8081" # 将容器端口映射到主机端口
        environment:
            - SPRING_PROFILES_ACTIVE=docker # 指定 Spring 配置文件环境
        # - NACOS_SERVER_ADDR=nacos:8848 # 指向 Nacos 服务，使用服务名
        # - MYSQL_HOST=mysql # 指向 MySQL 服务，使用服务名
        # - MYSQL_PORT=3306
        # - MYSQL_DATABASE=tlgp
        # - MYSQL_USER=user
        # - MYSQL_PASSWORD=mysql
        depends_on:
            - nacos
            - mysql
        # volumes:
        #   - /path/to/local/config:/app/config # 挂载配置文件 (可选)
    tlgp-user-service: # 服务名
        # 如果镜像已构建好并推送到仓库
        # image: your-registry/user-service:v1.0
        # 如果使用本地构建
        build:
            context: ./tlgp-user-service # Dockerfile 所在的相对路径
            dockerfile: Dockerfile
        container_name: tlgp-user-service
        restart: always
        ports:
            - "8082:8082" # 将容器端口映射到主机端口
        environment:
            - SPRING_PROFILES_ACTIVE=docker # 指定 Spring 配置文件环境
        # - NACOS_SERVER_ADDR=nacos:8848 # 指向 Nacos 服务，使用服务名
        # - MYSQL_HOST=mysql # 指向 MySQL 服务，使用服务名
        # - MYSQL_PORT=3306
        # - MYSQL_DATABASE=tlgp
        # - MYSQL_USER=user
        # - MYSQL_PASSWORD=mysql
        depends_on:
            - nacos
            - mysql
        # volumes:
        #   - /path/to/local/config:/app/config # 挂载配置文件 (可选): # 服务名
